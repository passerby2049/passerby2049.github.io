<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Á©∫Ê¥ûÈ™ëÂ£´Ôºö‰∏ù‰πãÊ≠å Â≠òÊ°£ÁºñËæëÂô®</title>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-J3VQJ8RSJM"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-J3VQJ8RSJM');
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.34.1/min/vs/loader.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1e1e2e 0%, #2d3748 100%);
            color: #e2e8f0;
            height: 100vh;
            overflow: hidden;
        }

        .container {
            display: flex;
            height: 100vh;
        }

        .sidebar {
            width: 320px;
            background: #1a1a2e;
            border-right: 1px solid #3a3a5c;
            display: flex;
            flex-direction: column;
            padding: 20px;
            overflow-y: auto;
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            color: #a855f7;
            font-size: 1.5rem;
            margin-bottom: 10px;
        }

        .upload-zone {
            border: 2px dashed #4c51bf;
            border-radius: 8px;
            padding: 40px 20px;
            text-align: center;
            margin-bottom: 20px;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .upload-zone:hover {
            border-color: #a855f7;
            background: rgba(168, 85, 247, 0.1);
        }

        .upload-zone.dragover {
            border-color: #a855f7;
            background: rgba(168, 85, 247, 0.2);
        }

        .upload-icon {
            font-size: 3rem;
            margin-bottom: 20px;
            color: #4c51bf;
        }

        .file-input {
            display: none;
        }

        .btn {
            background: #a855f7;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
            margin: 5px;
            display: inline-block;
            text-decoration: none;
        }

        .btn:hover {
            background: #9333ea;
            transform: translateY(-2px);
        }

        .btn:disabled {
            background: #4a5568;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: #4a5568;
        }

        .btn-secondary:hover {
            background: #2d3748;
        }

        .btn-danger {
            background: #dc2626;
        }

        .btn-danger:hover {
            background: #b91c1c;
        }

        .control-group {
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
        }

        .control-group h3 {
            margin-bottom: 15px;
            color: #a855f7;
            font-size: 1rem;
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-group label {
            display: block;
            margin-bottom: 5px;
            color: #cbd5e0;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .input-group input {
            width: 100%;
            padding: 8px 12px;
            background: #2d3748;
            border: 1px solid #4a5568;
            border-radius: 4px;
            color: #e2e8f0;
            font-size: 14px;
        }

        .input-group input:focus {
            outline: none;
            border-color: #a855f7;
            box-shadow: 0 0 0 3px rgba(168, 85, 247, 0.1);
        }

        .editor-container {
            flex: 1;
            position: relative;
            background: #1e1e2e;
        }

        .status-bar {
            background: #16213e;
            padding: 10px 20px;
            border-top: 1px solid #3a3a5c;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .status-success { background: #10b981; }
        .status-error { background: #ef4444; }
        .status-warning { background: #f59e0b; }
        .status-info { background: #3b82f6; }

        .upload-placeholder {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100%;
            text-align: center;
            color: #64748b;
        }

        .upload-placeholder-icon {
            font-size: 4rem;
            margin-bottom: 20px;
            color: #4c51bf;
        }

        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #1a1a2e;
            border: 1px solid #3a3a5c;
            border-radius: 8px;
            padding: 16px;
            max-width: 400px;
            z-index: 1000;
            transform: translateX(100%);
            transition: transform 0.3s ease;
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast.success { border-left: 4px solid #10b981; }
        .toast.error { border-left: 4px solid #ef4444; }

        .hidden {
            display: none !important;
        }

        .loading {
            opacity: 0.5;
            pointer-events: none;
        }

        .warning-banner {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
            color: white;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 8px;
            border-left: 4px solid #fbbf24;
            font-size: 14px;
            line-height: 1.5;
        }

        .warning-banner strong {
            color: #fbbf24;
        }

        .info-section {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.2);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            font-size: 13px;
            line-height: 1.4;
        }

        .info-section h4 {
            color: #3b82f6;
            margin-bottom: 10px;
            font-size: 14px;
        }

        .path-list {
            background: rgba(0, 0, 0, 0.3);
            padding: 10px;
            border-radius: 4px;
            margin: 8px 0;
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 11px;
            word-break: break-all;
        }

        .os-section {
            margin-bottom: 12px;
        }

        .os-section strong {
            color: #10b981;
            display: inline-block;
            min-width: 80px;
        }

        .backup-steps {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.2);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            font-size: 13px;
            line-height: 1.4;
        }

        .backup-steps h4 {
            color: #10b981;
            margin-bottom: 10px;
            font-size: 14px;
        }

        .backup-steps ol {
            padding-left: 20px;
        }

        .backup-steps li {
            margin-bottom: 8px;
        }

        .accordion {
            border: 1px solid #3a3a5c;
            border-radius: 8px;
            margin-bottom: 15px;
            overflow: hidden;
        }

        .accordion-header {
            background: #2d3748;
            padding: 12px 15px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 500;
            transition: background 0.2s;
        }

        .accordion-header:hover {
            background: #374151;
        }

        .accordion-content {
            padding: 15px;
            border-top: 1px solid #3a3a5c;
            display: none;
        }

        .accordion.active .accordion-content {
            display: block;
        }

        .accordion-arrow {
            transition: transform 0.2s;
        }

        .accordion.active .accordion-arrow {
            transform: rotate(180deg);
        }

        .status-badge {
            font-size: 11px;
            padding: 2px 8px;
            border-radius: 12px;
            font-weight: 500;
        }

        .status-available {
            background: #10b981;
            color: white;
        }

        .status-unavailable {
            background: #dc2626;
            color: white;
        }

        .status-unknown {
            background: #64748b;
            color: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- ‰æßËæπÊ†è -->
        <div class="sidebar">
            <div class="header">
                <h1>üï∏Ô∏è ‰∏ù‰πãÊ≠åÂ≠òÊ°£ÁºñËæëÂô®</h1>
                <p style="color: #64748b; font-size: 12px;">‰∏ä‰º†Â≠òÊ°£Êñá‰ª∂ÂºÄÂßãÁºñËæë</p>
            </div>

            <!-- ÈáçË¶ÅË≠¶Âëä -->
            <div class="warning-banner">
                <strong>‚ö†Ô∏è ÈáçË¶ÅÊèêÈÜíÔºö</strong><br>
                Âú®‰ΩøÁî®Ê≠§Â∑•ÂÖ∑ÂâçÔºåËØ∑Âä°ÂøÖÂ§á‰ªΩÊÇ®ÁöÑÂéüÂßãÂ≠òÊ°£Êñá‰ª∂ÔºÅ‰øÆÊîπÂ≠òÊ°£Êñá‰ª∂ÂèØËÉΩÂØºËá¥Ê∏∏ÊàèÊó†Ê≥ïÊ≠£Â∏∏ËøêË°åÊàñÂ≠òÊ°£ÊçüÂùè„ÄÇ
            </div>

            <!-- ÊäòÂè†Âºè‰ø°ÊÅØÂå∫Âüü -->
            <div class="accordion">
                <div class="accordion-header" onclick="toggleAccordion(this)">
                    <span>üìÅ Â≠òÊ°£Êñá‰ª∂‰ΩçÁΩÆ</span>
                    <span class="accordion-arrow">‚ñº</span>
                </div>
                <div class="accordion-content">
                    <div class="info-section">
                        <h4>üñ•Ô∏è Â≠òÊ°£Êñá‰ª∂Ë∑ØÂæÑ</h4>
                        <div class="os-section">
                            <strong>Windows:</strong>
                            <div class="path-list">%USERPROFILE%\AppData\LocalLow\Team Cherry\Hollow Knight Silksong\</div>
                        </div>
                        <div class="os-section">
                            <strong>macOS:</strong>
                            <div class="path-list">~/Library/Application Support/unity.Team Cherry.Hollow Knight Silksong/</div>
                        </div>
                        <div class="os-section">
                            <strong>Linux:</strong>
                            <div class="path-list">~/.config/unity3d/Team Cherry/Hollow Knight Silksong/</div>
                        </div>
                        <div class="os-section">
                            <strong>Steam Deck:</strong>
                            <div class="path-list">~/.local/share/Steam/steamapps/compatdata/[APPID]/pfx/drive_c/users/steamuser/AppData/LocalLow/Team Cherry/Hollow Knight Silksong/</div>
                        </div>
                        <p style="color: #94a3b8; margin-top: 10px; font-size: 12px;">
                            <strong>ÊèêÁ§∫Ôºö</strong>Â≠òÊ°£Êñá‰ª∂ÈÄöÂ∏∏Âêç‰∏∫ user1.dat„ÄÅuser2.dat Á≠â„ÄÇ
                        </p>
                    </div>
                </div>
            </div>

            <div class="accordion">
                <div class="accordion-header" onclick="toggleAccordion(this)">
                    <span>üíæ Â§á‰ªΩÊ≠•È™§</span>
                    <span class="accordion-arrow">‚ñº</span>
                </div>
                <div class="accordion-content">
                    <div class="backup-steps">
                        <h4>üõ°Ô∏è Â¶Ç‰ΩïÂ§á‰ªΩÂ≠òÊ°£</h4>
                        <ol>
                            <li>ÊâæÂà∞‰∏äËø∞ÂØπÂ∫îÂπ≥Âè∞ÁöÑÂ≠òÊ°£Êñá‰ª∂Â§π</li>
                            <li>Â§çÂà∂Êï¥‰∏™Â≠òÊ°£Êñá‰ª∂Â§πÂà∞ÂÆâÂÖ®‰ΩçÁΩÆÔºàÂ¶ÇÊ°åÈù¢ÊàñÊñáÊ°£Êñá‰ª∂Â§πÔºâ</li>
                            <li>ÈáçÂëΩÂêçÂ§á‰ªΩÊñá‰ª∂Â§πÔºåÊ∑ªÂä†Êó•ÊúüÂêéÁºÄÔºàÂ¶Ç "Â≠òÊ°£Â§á‰ªΩ_2024-01-01"Ôºâ</li>
                            <li>Á°ÆËÆ§Â§á‰ªΩÊñá‰ª∂Â§πÂåÖÂê´ÊâÄÊúâ .dat Êñá‰ª∂</li>
                            <li>Áé∞Âú®ÂèØ‰ª•ÂÆâÂÖ®Âú∞‰ΩøÁî®Ê≠§Â∑•ÂÖ∑ÁºñËæëÂ≠òÊ°£</li>
                        </ol>
                        <p style="color: #94a3b8; margin-top: 10px; font-size: 12px;">
                            <strong>ÊÅ¢Â§çÊñπÊ≥ïÔºö</strong>Â¶ÇÊûúÂá∫Áé∞ÈóÆÈ¢òÔºåÂà†Èô§ÂΩìÂâçÂ≠òÊ°£Êñá‰ª∂Â§πÔºåÂ∞ÜÂ§á‰ªΩÊñá‰ª∂Â§πÈáçÂëΩÂêçÂõûÂéüÊù•ÁöÑÂêçÁß∞Âç≥ÂèØ„ÄÇ
                        </p>
                    </div>
                </div>
            </div>

            <div class="accordion">
                <div class="accordion-header" onclick="toggleAccordion(this)">
                    <span>‚ÑπÔ∏è ‰ΩøÁî®ËØ¥Êòé</span>
                    <span class="accordion-arrow">‚ñº</span>
                </div>
                <div class="accordion-content">
                    <div class="info-section">
                        <h4>üéÆ ‰ΩøÁî®ÊñπÊ≥ï</h4>
                        <ol style="padding-left: 20px; line-height: 1.6;">
                            <li>Â§á‰ªΩÂéüÂßãÂ≠òÊ°£Êñá‰ª∂</li>
                            <li>‰∏ä‰º†Â≠òÊ°£Êñá‰ª∂Ôºà.dat Ê†ºÂºèÔºâ</li>
                            <li>Âú®Âè≥‰æßÁºñËæëÂô®‰∏≠‰øÆÊîπ JSON Êï∞ÊçÆ</li>
                            <li>Êàñ‰ΩøÁî®Â∑¶‰æßÂø´ÈÄüÁºñËæëÊéß‰ª∂</li>
                            <li>ÁÇπÂáª"‰∏ãËΩΩÂ≠òÊ°£"Ëé∑Âèñ‰øÆÊîπÂêéÁöÑÊñá‰ª∂</li>
                            <li>Â∞Ü‰øÆÊîπÂêéÁöÑÊñá‰ª∂ÊõøÊç¢Âà∞Ê∏∏ÊàèÂ≠òÊ°£Êñá‰ª∂Â§π</li>
                        </ol>
                        <p style="color: #f59e0b; margin-top: 10px; font-size: 12px;">
                            <strong>Ê≥®ÊÑèÔºö</strong>ËØ∑Á°Æ‰øù JSON Ê†ºÂºèÊ≠£Á°ÆÔºåÂê¶ÂàôÂèØËÉΩÂØºËá¥Â≠òÊ°£Êó†Ê≥ïÂä†ËΩΩ„ÄÇ
                        </p>
                    </div>
                </div>
            </div>

            <!-- ‰∏ä‰º†Âå∫Âüü -->
            <div class="upload-zone" onclick="document.getElementById('fileInput').click()">
                <div class="upload-icon">üìÅ</div>
                <div>
                    <strong>ÁÇπÂáªÊàñÊãñÊãΩ‰∏ä‰º†Â≠òÊ°£Êñá‰ª∂</strong>
                    <br>
                    <small style="color: #64748b;">ÊîØÊåÅ Silksong Â≠òÊ°£Ê†ºÂºè</small>
                </div>
                <input type="file" id="fileInput" class="file-input" accept=".dat,.save">
            </div>

            <!-- ÊéßÂà∂ÊåâÈíÆ -->
            <div style="display: flex; flex-wrap: wrap; justify-content: center; margin-bottom: 20px;">
                <button class="btn" id="downloadBtn" disabled>üíæ ‰∏ãËΩΩÂ≠òÊ°£</button>
                <button class="btn btn-secondary" id="resetBtn" disabled>üîÑ ÈáçÁΩÆ‰øÆÊîπ</button>
                <button class="btn btn-danger" id="clearBtn" disabled>üóëÔ∏è Ê∏ÖÈô§Êï∞ÊçÆ</button>
            </div>

            <!-- Âø´ÈÄüÁºñËæëÊéß‰ª∂ -->
            <div id="quickControls" class="hidden">
                <div class="control-group">
                    <h3>üí∞ Âø´Êç∑Êìç‰Ωú</h3>
                    
                    <!-- ÂøµÁè†Êï∞Èáè -->
                    <div class="input-group">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                            <label>ÂøµÁè†Êï∞Èáè</label>
                            <span id="geoStatus" class="status-badge">‚Äî</span>
                        </div>
                        <input type="number" id="geoInput" min="0" max="999999" placeholder="ËæìÂÖ•Êï∞Èáè">
                        <p style="color: #94a3b8; font-size: 11px; margin-top: 5px;">
                            ÂΩìÂâçÂøµÁè†Êï∞Èáè (playerData.geo)
                        </p>
                    </div>

                    <!-- ÁîüÂëΩÂÄº -->
                    <div class="input-group">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                            <label>ÁîüÂëΩÂÄº</label>
                            <span id="healthStatus" class="status-badge">‚Äî</span>
                        </div>
                        <input type="number" id="healthInput" min="1" max="50" placeholder="ËæìÂÖ•ÁîüÂëΩÂÄº">
                        <p style="color: #94a3b8; font-size: 11px; margin-top: 5px;">
                            ÊúÄÂ§ßÁîüÂëΩÂÄº (maxHealth & maxHealthBase)
                        </p>
                    </div>

                    <!-- È™®ÈíâÂçáÁ∫ßÊ¨°Êï∞ -->
                    <div class="input-group">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                            <label>È™®ÈíâÂçáÁ∫ßÊ¨°Êï∞</label>
                            <span id="nailStatus" class="status-badge">‚Äî</span>
                        </div>
                        <input type="number" id="nailInput" min="0" max="1000" placeholder="ËæìÂÖ•ÂçáÁ∫ßÊ¨°Êï∞">
                        <p style="color: #94a3b8; font-size: 11px; margin-top: 5px;">
                            È™®ÈíâÂçáÁ∫ßÊ¨°Êï∞ (playerData.nailUpgrades)
                        </p>
                    </div>

                    <!-- Áî≤Â£≥Á¢éÁâá -->
                    <div class="input-group">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                            <label>Áî≤Â£≥Á¢éÁâá</label>
                            <span id="shellStatus" class="status-badge">‚Äî</span>
                        </div>
                        <input type="number" id="shellInput" min="0" max="999" placeholder="ËæìÂÖ•Êï∞Èáè">
                        <p style="color: #94a3b8; font-size: 11px; margin-top: 5px;">
                            Áî≤Â£≥Á¢éÁâáÊï∞Èáè (playerData.ShellShards)
                        </p>
                    </div>

                    <!-- ÁÅµ‰∏ùËá™Âä®ÂõûÂ§çÈÄüÂ∫¶ -->
                    <div class="input-group">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                            <label>ÁÅµ‰∏ùËá™Âä®ÂõûÂ§çÈÄüÂ∫¶</label>
                            <span id="silkStatus" class="status-badge">‚Äî</span>
                        </div>
                        <input type="number" id="silkInput" min="0" max="100" placeholder="ËæìÂÖ•ÈÄüÂ∫¶">
                        <p style="color: #94a3b8; font-size: 11px; margin-top: 5px;">
                            ÁÅµ‰∏ùËá™Âä®ÂõûÂ§çÈÄüÂ∫¶ (playerData.silkRegenMax)
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- ‰∏ªÂÜÖÂÆπÂå∫ -->
        <div class="main-content">
            <div class="editor-container" id="editorContainer">
                <div class="upload-placeholder" id="uploadPlaceholder">
                    <div class="upload-placeholder-icon">üï∏Ô∏è</div>
                    <h2>Á©∫Ê¥ûÈ™ëÂ£´Ôºö‰∏ù‰πãÊ≠åÂ≠òÊ°£ÁºñËæëÂô®</h2>
                    <p>ËØ∑Âú®Â∑¶‰æß‰∏ä‰º†Â≠òÊ°£Êñá‰ª∂ÂºÄÂßãÁºñËæë</p>
                </div>
                <div id="monacoEditor" style="height: 100%; display: none;"></div>
            </div>
            
            <!-- Áä∂ÊÄÅÊ†è -->
            <div class="status-bar">
                <div class="status-indicator">
                    <div class="status-dot status-info" id="statusDot"></div>
                    <span id="statusText">Â∞±Áª™</span>
                </div>
                <div id="statusInfo">
                    <span>JSON Ê†ºÂºèÊ≠£Á°Æ</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast ÈÄöÁü• -->
    <div id="toast" class="toast"></div>

    <script>
        // ÂÖ®Â±ÄÂèòÈáè
        let editor = null;
        let saveData = null;
        let originalJsonContent = '';
        let isValidJson = true;

        // AES ÂØÜÈí•ÂíåÂ§¥ÈÉ®‰ø°ÊÅØ
        const AES_KEY = 'UKu52ePUBwetZ9wNX88o54dnfKRu0T1l';
        const CSHARP_HEADER = new Uint8Array([0, 1, 0, 0, 0, 255, 255, 255, 255, 1, 0, 0, 0, 0, 0, 0, 0, 6, 1, 0, 0, 0]);

        // ÂàùÂßãÂåñ Monaco ÁºñËæëÂô®
        function initMonacoEditor() {
            require.config({ paths: { vs: 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.34.1/min/vs' }});
            require(['vs/editor/editor.main'], function () {
                editor = monaco.editor.create(document.getElementById('monacoEditor'), {
                    value: '',
                    language: 'json',
                    theme: 'vs-dark',
                    automaticLayout: true,
                    formatOnPaste: true,
                    formatOnType: true,
                    scrollBeyondLastLine: false,
                    minimap: { enabled: false },
                    fontSize: 14,
                    lineNumbers: 'on',
                    folding: true,
                    wordWrap: 'on'
                });

                // ÁõëÂê¨ÂÜÖÂÆπÂèòÂåñ
                editor.onDidChangeModelContent(() => {
                    const content = editor.getValue();
                    validateJson(content);
                    updateQuickControls();
                });
            });
        }

        // ÊòæÁ§∫ÈÄöÁü•
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type} show`;
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // Êõ¥Êñ∞Áä∂ÊÄÅ
        function updateStatus(message, type = 'info') {
            const statusDot = document.getElementById('statusDot');
            const statusText = document.getElementById('statusText');
            
            statusDot.className = `status-dot status-${type}`;
            statusText.textContent = message;
        }

        // ÁßªÈô§Êñá‰ª∂Â§¥ÈÉ®
        function removeHeader(data) {
            let offset = 22; // C# Â§¥ÈÉ®ÈïøÂ∫¶
            
            // Ëß£ÊûêÈïøÂ∫¶ÂâçÁºÄÂ≠óÁ¨¶‰∏≤Â§¥ÈÉ® (LEB128 ÁºñÁ†Å)
            let length = 0;
            let shift = 0;
            let lengthBytes = 0;
            
            for (let i = 0; i < 5 && offset + i < data.length; i++) {
                const byte = data[offset + i];
                length |= (byte & 0x7F) << shift;
                lengthBytes++;
                if ((byte & 0x80) === 0) {
                    break;
                }
                shift += 7;
            }
            
            offset += lengthBytes;
            
            // ÁßªÈô§Â∞æÈÉ®Â≠óËäÇ (11) - ËøîÂõûÊó∂‰∏çÂåÖÂê´ÊúÄÂêé‰∏Ä‰∏™Â≠óËäÇ
            return data.slice(offset, -1);
        }

        // Ê∑ªÂä†Êñá‰ª∂Â§¥ÈÉ®
        function addHeader(base64Data) {
            const dataLength = base64Data.length;
            
            // ÁîüÊàêÈïøÂ∫¶Â§¥ÈÉ® (LEB128)
            const lengthHeader = [];
            let length = dataLength;
            
            while (length >= 0x80) {
                lengthHeader.push((length & 0x7F) | 0x80);
                length >>>= 7;
            }
            lengthHeader.push(length & 0x7F);
            
            // ÂêàÂπ∂ÊâÄÊúâÈÉ®ÂàÜ
            const result = new Uint8Array(CSHARP_HEADER.length + lengthHeader.length + base64Data.length + 1);
            let offset = 0;
            
            // C# Â§¥ÈÉ®
            result.set(CSHARP_HEADER, offset);
            offset += CSHARP_HEADER.length;
            
            // ÈïøÂ∫¶Â§¥ÈÉ®
            result.set(lengthHeader, offset);
            offset += lengthHeader.length;
            
            // Base64 Êï∞ÊçÆ
            result.set(base64Data, offset);
            offset += base64Data.length;
            
            // Â∞æÈÉ®Â≠óËäÇ
            result[offset] = 11;
            
            return result;
        }

        // Ëß£Á†ÅÂ≠òÊ°£Êñá‰ª∂
        function decodeSilksongSave(fileData) {
            try {
                const data = new Uint8Array(fileData);
                
                // 1. ÁßªÈô§Â§¥ÈÉ®
                const dataNoHeader = removeHeader(data);
                
                // 2. Base64 Ëß£Á†Å
                const base64String = new TextDecoder().decode(dataNoHeader)
                    .replace(/\n/g, '')
                    .replace(/\r/g, '')
                    .trim();
                
                const encryptedData = CryptoJS.enc.Base64.parse(base64String);
                
                // 3. AES Ëß£ÂØÜ
                const decrypted = CryptoJS.AES.decrypt(
                    { ciphertext: encryptedData },
                    CryptoJS.enc.Utf8.parse(AES_KEY),
                    {
                        mode: CryptoJS.mode.ECB,
                        padding: CryptoJS.pad.Pkcs7
                    }
                );
                
                // 4. Ëß£Êûê JSON
                const jsonString = decrypted.toString(CryptoJS.enc.Utf8);
                return JSON.parse(jsonString);
                
            } catch (error) {
                console.error('Ëß£Á†ÅÂ≠òÊ°£Êñá‰ª∂ÈîôËØØ:', error);
                throw new Error('Ëß£Á†ÅÂ≠òÊ°£Êñá‰ª∂Â§±Ë¥•„ÄÇËØ∑Ê£ÄÊü•Êñá‰ª∂Ê†ºÂºè„ÄÇ');
            }
        }

        // ÁºñÁ†ÅÂ≠òÊ°£Êñá‰ª∂
        function encodeSilksongSave(saveData) {
            try {
                // 1. ËΩ¨Êç¢‰∏∫ JSON Â≠óÁ¨¶‰∏≤
                const jsonString = JSON.stringify(saveData, null, 0);
                
                // 2. AES Âä†ÂØÜ
                const encrypted = CryptoJS.AES.encrypt(
                    jsonString,
                    CryptoJS.enc.Utf8.parse(AES_KEY),
                    {
                        mode: CryptoJS.mode.ECB,
                        padding: CryptoJS.pad.Pkcs7
                    }
                );
                
                // 3. Base64 ÁºñÁ†Å
                const base64String = encrypted.toString();
                const base64Data = new TextEncoder().encode(base64String);
                
                // 4. Ê∑ªÂä†Â§¥ÈÉ®
                return addHeader(base64Data);
                
            } catch (error) {
                console.error('ÁºñÁ†ÅÂ≠òÊ°£Êñá‰ª∂ÈîôËØØ:', error);
                throw new Error('ÁºñÁ†ÅÂ≠òÊ°£Êñá‰ª∂Â§±Ë¥•„ÄÇËØ∑Ê£ÄÊü•ÊÇ®ÁöÑ‰øÆÊîπ„ÄÇ');
            }
        }

        // È™åËØÅ JSON
        function validateJson(jsonString) {
            try {
                JSON.parse(jsonString);
                isValidJson = true;
                document.getElementById('statusInfo').textContent = 'JSON Ê†ºÂºèÊ≠£Á°Æ';
                return true;
            } catch (error) {
                isValidJson = false;
                document.getElementById('statusInfo').textContent = 'JSON Ê†ºÂºèÈîôËØØ: ' + error.message;
                return false;
            }
        }

        // Êõ¥Êñ∞Âø´ÈÄüÊéß‰ª∂
        function updateQuickControls() {
            if (!editor || !isValidJson) return;
            
            try {
                const content = editor.getValue();
                const data = JSON.parse(content);
                
                // Êõ¥Êñ∞ÂøµÁè†Â≠óÊÆµ
                updateFieldControl(data, 'geo', 'geoInput', 'geoStatus', 
                    ['playerData.geo'], 'number');
                
                // Êõ¥Êñ∞ÁîüÂëΩÂÄºÂ≠óÊÆµ (ÂêåÊó∂Â§ÑÁêÜmaxHealthÂíåmaxHealthBase)
                updateHealthFields(data);
                
                // Êõ¥Êñ∞È™®ÈíâÂçáÁ∫ßÊ¨°Êï∞Â≠óÊÆµ
                updateFieldControl(data, 'nail', 'nailInput', 'nailStatus', 
                    ['playerData.nailUpgrades'], 'number');
                
                // Êõ¥Êñ∞Áî≤Â£≥Á¢éÁâáÂ≠óÊÆµ
                updateFieldControl(data, 'shell', 'shellInput', 'shellStatus', 
                    ['playerData.ShellShards'], 'number');
                
                // Êõ¥Êñ∞ÁÅµ‰∏ùËá™Âä®ÂõûÂ§çÈÄüÂ∫¶Â≠óÊÆµ
                updateFieldControl(data, 'silk', 'silkInput', 'silkStatus', 
                    ['playerData.silkRegenMax'], 'number');
                
            } catch (error) {
                console.error('Êõ¥Êñ∞Âø´ÈÄüÊéß‰ª∂ÈîôËØØ:', error);
                // ÈáçÁΩÆÊâÄÊúâÁä∂ÊÄÅ‰∏∫Êú™Áü•
                ['geoStatus', 'healthStatus', 'nailStatus', 'shellStatus', 'silkStatus'].forEach(statusId => {
                    const status = document.getElementById(statusId);
                    status.textContent = '‚Äî';
                    status.className = 'status-badge status-unknown';
                });
            }
        }

        // ÈÄöÁî®Â≠óÊÆµÊéß‰ª∂Êõ¥Êñ∞ÂáΩÊï∞
        function updateFieldControl(data, fieldType, inputId, statusId, fieldPaths, valueType) {
            const input = document.getElementById(inputId);
            const status = document.getElementById(statusId);
            
            let foundField = false;
            let fieldValue = null;
            let actualFieldPath = '';
            
            // Â∞ùËØïÊâÄÊúâÂèØËÉΩÁöÑÂ≠óÊÆµË∑ØÂæÑ
            for (const path of fieldPaths) {
                const value = getNestedValue(data, path);
                if (value !== undefined) {
                    foundField = true;
                    fieldValue = value;
                    actualFieldPath = path;
                    break;
                }
            }
            
            if (foundField) {
                input.value = fieldValue.toString();
                input.disabled = false;
                status.textContent = '‚úì';
                status.className = 'status-badge status-available';
                status.title = `Â≠óÊÆµË∑ØÂæÑ: ${actualFieldPath}`;
                
                // Ê†πÊçÆÂ≠óÊÆµÁ±ªÂûãËÆæÁΩÆÂç†‰ΩçÁ¨¶
                if (fieldType === 'nail') {
                    input.placeholder = 'ËæìÂÖ•ÂçáÁ∫ßÊ¨°Êï∞ (0-1000)';
                } else {
                    input.placeholder = 'ËæìÂÖ•Êï∞Èáè';
                }
            } else {
                input.value = '';
                input.disabled = true;
                status.textContent = '‚úó';
                status.className = 'status-badge status-unavailable';
                status.title = 'Â≠óÊÆµ‰∏çÂèØÁî®';
                input.placeholder = 'Â≠óÊÆµ‰∏çÂèØÁî®';
            }
            
            // Â≠òÂÇ®Â≠óÊÆµË∑ØÂæÑÂà∞inputÂÖÉÁ¥†ÔºåÁî®‰∫éÊõ¥Êñ∞Êó∂‰ΩøÁî®
            input.dataset.fieldPath = actualFieldPath;
            input.dataset.valueType = valueType;
        }

        // Ëé∑ÂèñÂµåÂ•óÂØπË±°ÁöÑÂÄº
        function getNestedValue(obj, path) {
            return path.split('.').reduce((current, key) => {
                return current && current[key] !== undefined ? current[key] : undefined;
            }, obj);
        }

        // ‰∏ìÈó®Â§ÑÁêÜÁîüÂëΩÂÄºÂ≠óÊÆµÁöÑÂáΩÊï∞
        function updateHealthFields(data) {
            const healthInput = document.getElementById('healthInput');
            const healthStatus = document.getElementById('healthStatus');
            
            const maxHealth = getNestedValue(data, 'playerData.maxHealth');
            const maxHealthBase = getNestedValue(data, 'playerData.maxHealthBase');
            
            const hasMaxHealth = maxHealth !== undefined;
            const hasMaxHealthBase = maxHealthBase !== undefined;
            
            if (hasMaxHealth || hasMaxHealthBase) {
                // ‰ºòÂÖàÊòæÁ§∫maxHealthÔºåÂ¶ÇÊûúÊ≤°ÊúâÂàôÊòæÁ§∫maxHealthBase
                const displayValue = hasMaxHealth ? maxHealth : maxHealthBase;
                healthInput.value = displayValue.toString();
                healthInput.disabled = false;
                healthStatus.textContent = '‚úì';
                healthStatus.className = 'status-badge status-available';
                
                // ËÆæÁΩÆÂ∑•ÂÖ∑ÊèêÁ§∫ÔºåÊòæÁ§∫ÊâæÂà∞‰∫ÜÂì™‰∫õÂ≠óÊÆµ
                let tooltip = 'ÊâæÂà∞Â≠óÊÆµ: ';
                if (hasMaxHealth && hasMaxHealthBase) {
                    tooltip += 'maxHealth & maxHealthBase';
                } else if (hasMaxHealth) {
                    tooltip += 'maxHealth';
                } else {
                    tooltip += 'maxHealthBase';
                }
                healthStatus.title = tooltip;
                healthInput.placeholder = 'ËæìÂÖ•ÁîüÂëΩÂÄº';
                
                // Â≠òÂÇ®Â≠óÊÆµ‰ø°ÊÅØÂà∞inputÂÖÉÁ¥†
                healthInput.dataset.hasMaxHealth = hasMaxHealth;
                healthInput.dataset.hasMaxHealthBase = hasMaxHealthBase;
                healthInput.dataset.valueType = 'number';
            } else {
                healthInput.value = '';
                healthInput.disabled = true;
                healthStatus.textContent = '‚úó';
                healthStatus.className = 'status-badge status-unavailable';
                healthStatus.title = 'Â≠óÊÆµ‰∏çÂèØÁî®';
                healthInput.placeholder = 'Â≠óÊÆµ‰∏çÂèØÁî®';
            }
        }

        // Â§ÑÁêÜÊñá‰ª∂‰∏ä‰º†
        function handleFileUpload(file) {
            updateStatus('Ê≠£Âú®Âä†ËΩΩ...', 'info');
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const decoded = decodeSilksongSave(e.target.result);
                    const jsonString = JSON.stringify(decoded, null, 2);
                    
                    saveData = decoded;
                    originalJsonContent = jsonString;
                    
                    // ÊòæÁ§∫ÁºñËæëÂô®Âπ∂ÈöêËóè‰∏ä‰º†ÊèêÁ§∫
                    document.getElementById('uploadPlaceholder').style.display = 'none';
                    document.getElementById('monacoEditor').style.display = 'block';
                    document.getElementById('quickControls').classList.remove('hidden');
                    
                    // ËÆæÁΩÆÁºñËæëÂô®ÂÜÖÂÆπ
                    if (editor) {
                        editor.setValue(jsonString);
                    }
                    
                    // ÂêØÁî®ÊåâÈíÆ
                    document.getElementById('downloadBtn').disabled = false;
                    document.getElementById('resetBtn').disabled = false;
                    document.getElementById('clearBtn').disabled = false;
                    
                    updateStatus('Êñá‰ª∂Âä†ËΩΩÊàêÂäü', 'success');
                    showToast('Â≠òÊ°£Êñá‰ª∂‰∏ä‰º†ÊàêÂäüÔºÅ', 'success');
                    
                } catch (error) {
                    console.error('‰∏ä‰º†ÈîôËØØ:', error);
                    updateStatus('Êñá‰ª∂Âä†ËΩΩÂ§±Ë¥•', 'error');
                    showToast('‰∏ä‰º†Â§±Ë¥•: ' + error.message, 'error');
                }
            };
            
            reader.readAsArrayBuffer(file);
        }

        // ‰∏ãËΩΩÊñá‰ª∂
        function downloadFile() {
            if (!editor || !isValidJson) {
                showToast('ËØ∑Á°Æ‰øù JSON Ê†ºÂºèÊ≠£Á°Æ', 'error');
                return;
            }

            try {
                const jsonContent = editor.getValue();
                const parsedData = JSON.parse(jsonContent);
                const encodedData = encodeSilksongSave(parsedData);
                
                const blob = new Blob([encodedData], { type: 'application/octet-stream' });
                const url = URL.createObjectURL(blob);
                
                const link = document.createElement('a');
                link.href = url;
                link.download = 'silksong_save_modified.dat';
                document.body.appendChild(link);
                link.click();
                
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                showToast('Â≠òÊ°£Êñá‰ª∂‰∏ãËΩΩÊàêÂäüÔºÅ', 'success');
                
            } catch (error) {
                console.error('‰∏ãËΩΩÈîôËØØ:', error);
                showToast('‰∏ãËΩΩÂ§±Ë¥•: ' + error.message, 'error');
            }
        }

        // ÈáçÁΩÆ‰øÆÊîπ
        function resetChanges() {
            if (originalJsonContent && editor) {
                editor.setValue(originalJsonContent);
                showToast('Â∑≤ÈáçÁΩÆ‰∏∫ÂéüÂßãÂÜÖÂÆπ', 'success');
            }
        }

        // Ê∏ÖÈô§ÊâÄÊúâÊï∞ÊçÆ
        function clearAll() {
            if (confirm('Á°ÆÂÆöË¶ÅÊ∏ÖÈô§ÊâÄÊúâÊï∞ÊçÆÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊÅ¢Â§ç„ÄÇ')) {
                saveData = null;
                originalJsonContent = '';
                
                if (editor) {
                    editor.setValue('');
                }
                
                document.getElementById('uploadPlaceholder').style.display = 'flex';
                document.getElementById('monacoEditor').style.display = 'none';
                document.getElementById('quickControls').classList.add('hidden');
                
                // Á¶ÅÁî®ÊåâÈíÆ
                document.getElementById('downloadBtn').disabled = true;
                document.getElementById('resetBtn').disabled = true;
                document.getElementById('clearBtn').disabled = true;
                
                updateStatus('Â∞±Áª™', 'info');
                showToast('Êï∞ÊçÆÂ∑≤Ê∏ÖÈô§', 'success');
            }
        }

        // Âø´ÈÄüÁºñËæëÂäüËÉΩ
        function updateField(path, value) {
            if (!editor || !isValidJson) return;
            
            try {
                const jsonContent = editor.getValue();
                const data = JSON.parse(jsonContent);
                
                // Ê†πÊçÆË∑ØÂæÑÊõ¥Êñ∞ÂÄº
                const pathParts = path.split('.');
                let target = data;
                
                for (let i = 0; i < pathParts.length - 1; i++) {
                    if (target[pathParts[i]] === undefined) {
                        target[pathParts[i]] = {};
                    }
                    target = target[pathParts[i]];
                }
                
                target[pathParts[pathParts.length - 1]] = value;
                
                const updatedJson = JSON.stringify(data, null, 2);
                editor.setValue(updatedJson);
                
            } catch (error) {
                console.error('Êõ¥Êñ∞Â≠óÊÆµÈîôËØØ:', error);
            }
        }

        // ÊäòÂè†ËèúÂçïÂäüËÉΩ
        function toggleAccordion(header) {
            const accordion = header.parentElement;
            const isActive = accordion.classList.contains('active');
            
            // ÂÖ≥Èó≠ÊâÄÊúâÂÖ∂‰ªñÊäòÂè†ËèúÂçï
            document.querySelectorAll('.accordion.active').forEach(acc => {
                if (acc !== accordion) {
                    acc.classList.remove('active');
                }
            });
            
            // ÂàáÊç¢ÂΩìÂâçËèúÂçïÁä∂ÊÄÅ
            if (isActive) {
                accordion.classList.remove('active');
            } else {
                accordion.classList.add('active');
            }
        }

        // ‰∫ã‰ª∂ÁõëÂê¨Âô®
        document.addEventListener('DOMContentLoaded', function() {
            // ÂàùÂßãÂåñÁºñËæëÂô®
            initMonacoEditor();
            
            // Êñá‰ª∂ËæìÂÖ•
            const fileInput = document.getElementById('fileInput');
            fileInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    handleFileUpload(file);
                }
            });
            
            // ÊãñÊîæÂ§ÑÁêÜ
            const uploadZone = document.querySelector('.upload-zone');
            uploadZone.addEventListener('dragover', function(e) {
                e.preventDefault();
                uploadZone.classList.add('dragover');
            });
            
            uploadZone.addEventListener('dragleave', function(e) {
                e.preventDefault();
                uploadZone.classList.remove('dragover');
            });
            
            uploadZone.addEventListener('drop', function(e) {
                e.preventDefault();
                uploadZone.classList.remove('dragover');
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleFileUpload(files[0]);
                }
            });
            
            // ÊåâÈíÆ‰∫ã‰ª∂
            document.getElementById('downloadBtn').addEventListener('click', downloadFile);
            document.getElementById('resetBtn').addEventListener('click', resetChanges);
            document.getElementById('clearBtn').addEventListener('click', clearAll);
            
            // ÈÄöÁî®ËæìÂÖ•Ê°Ü‰∫ã‰ª∂Â§ÑÁêÜÂáΩÊï∞
            function setupFieldEventListener(inputId) {
                document.getElementById(inputId).addEventListener('input', function(e) {
                    const value = e.target.value;
                    
                    // Â¶ÇÊûúÂ≠óÊÆµ‰∏çÂèØÁî®Ôºå‰∏çÂ§ÑÁêÜËæìÂÖ•
                    if (e.target.disabled) return;
                    
                    // È™åËØÅËæìÂÖ•Ê†ºÂºè
                    let isValidInput = false;
                    let processedValue = null;
                    
                    if (value === '') {
                        isValidInput = true;
                    } else {
                        // ÊâÄÊúâÂ≠óÊÆµÈÉΩÂè™ÂÖÅËÆ∏ÈùûË¥üÊï¥Êï∞
                        if (/^\d+$/.test(value)) {
                            const numValue = parseInt(value, 10);
                            
                            // Ê†πÊçÆÂ≠óÊÆµÁ±ªÂûãËÆæÁΩÆËåÉÂõ¥ÈôêÂà∂
                            if (inputId === 'nailInput' && numValue <= 1000) {
                                isValidInput = true;
                                processedValue = numValue;
                            } else if (inputId !== 'nailInput' && numValue >= 0) {
                                isValidInput = true;
                                processedValue = numValue;
                            }
                        }
                    }
                    
                    if (isValidInput && value !== '') {
                        // ÁâπÊÆäÂ§ÑÁêÜÁîüÂëΩÂÄºÂ≠óÊÆµ
                        if (inputId === 'healthInput') {
                            updateHealthValues(processedValue);
                        } else {
                            // ÂÖ∂‰ªñÂ≠óÊÆµ‰ΩøÁî®ÂéüÊúâÈÄªËæë
                            const fieldPath = e.target.dataset.fieldPath;
                            if (fieldPath) {
                                updateField(fieldPath, processedValue);
                            }
                        }
                    } else if (!isValidInput) {
                        // Â¶ÇÊûúËæìÂÖ•Êó†ÊïàÔºåÊÅ¢Â§çÂà∞‰πãÂâçÁöÑÂÄº
                        e.target.value = e.target.value.slice(0, -1);
                    }
                });
            }
            
            // ‰∏ìÈó®Êõ¥Êñ∞ÁîüÂëΩÂÄºÁöÑÂáΩÊï∞
            function updateHealthValues(value) {
                const healthInput = document.getElementById('healthInput');
                const hasMaxHealth = healthInput.dataset.hasMaxHealth === 'true';
                const hasMaxHealthBase = healthInput.dataset.hasMaxHealthBase === 'true';
                
                // ÂêåÊó∂Êõ¥Êñ∞‰∏§‰∏™Â≠óÊÆµ
                if (hasMaxHealth) {
                    updateField('playerData.maxHealth', value);
                }
                if (hasMaxHealthBase) {
                    updateField('playerData.maxHealthBase', value);
                }
            }
            
            // ‰∏∫ÊâÄÊúâËæìÂÖ•Ê°ÜËÆæÁΩÆ‰∫ã‰ª∂ÁõëÂê¨Âô®
            ['geoInput', 'healthInput', 'nailInput', 'shellInput', 'silkInput'].forEach(setupFieldEventListener);
        });
    </script>
</body>
</html>