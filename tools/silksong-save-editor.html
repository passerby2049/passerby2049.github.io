<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç©ºæ´éª‘å£«ï¼šä¸ä¹‹æ­Œ å­˜æ¡£ç¼–è¾‘å™¨</title>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-J3VQJ8RSJM"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-J3VQJ8RSJM');
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.34.1/min/vs/loader.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1e1e2e 0%, #2d3748 100%);
            color: #e2e8f0;
            height: 100vh;
            overflow: hidden;
        }

        .container {
            display: flex;
            height: 100vh;
        }

        .sidebar {
            width: 320px;
            background: #1a1a2e;
            border-right: 1px solid #3a3a5c;
            display: flex;
            flex-direction: column;
            padding: 20px;
            overflow-y: auto;
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            color: #a855f7;
            font-size: 1.5rem;
            margin-bottom: 10px;
        }

        .upload-zone {
            border: 2px dashed #4c51bf;
            border-radius: 8px;
            padding: 40px 20px;
            text-align: center;
            margin-bottom: 20px;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .upload-zone:hover {
            border-color: #a855f7;
            background: rgba(168, 85, 247, 0.1);
        }

        .upload-zone.dragover {
            border-color: #a855f7;
            background: rgba(168, 85, 247, 0.2);
        }

        .upload-icon {
            font-size: 3rem;
            margin-bottom: 20px;
            color: #4c51bf;
        }

        .file-input {
            display: none;
        }

        .btn {
            background: #a855f7;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
            margin: 5px;
            display: inline-block;
            text-decoration: none;
        }

        .btn:hover {
            background: #9333ea;
            transform: translateY(-2px);
        }

        .btn:disabled {
            background: #4a5568;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: #4a5568;
        }

        .btn-secondary:hover {
            background: #2d3748;
        }

        .btn-danger {
            background: #dc2626;
        }

        .btn-danger:hover {
            background: #b91c1c;
        }

        .control-group {
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
        }

        .control-group h3 {
            margin-bottom: 15px;
            color: #a855f7;
            font-size: 1rem;
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-group label {
            display: block;
            margin-bottom: 5px;
            color: #cbd5e0;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .input-group input {
            width: 100%;
            padding: 8px 12px;
            background: #2d3748;
            border: 1px solid #4a5568;
            border-radius: 4px;
            color: #e2e8f0;
            font-size: 14px;
        }

        .input-group input:focus {
            outline: none;
            border-color: #a855f7;
            box-shadow: 0 0 0 3px rgba(168, 85, 247, 0.1);
        }

        .editor-container {
            flex: 1;
            position: relative;
            background: #1e1e2e;
        }

        .status-bar {
            background: #16213e;
            padding: 10px 20px;
            border-top: 1px solid #3a3a5c;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .status-success { background: #10b981; }
        .status-error { background: #ef4444; }
        .status-warning { background: #f59e0b; }
        .status-info { background: #3b82f6; }

        .upload-placeholder {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100%;
            text-align: center;
            color: #64748b;
        }

        .upload-placeholder-icon {
            font-size: 4rem;
            margin-bottom: 20px;
            color: #4c51bf;
        }

        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #1a1a2e;
            border: 1px solid #3a3a5c;
            border-radius: 8px;
            padding: 16px;
            max-width: 400px;
            z-index: 1000;
            transform: translateX(100%);
            transition: transform 0.3s ease;
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast.success { border-left: 4px solid #10b981; }
        .toast.error { border-left: 4px solid #ef4444; }

        .hidden {
            display: none !important;
        }

        .loading {
            opacity: 0.5;
            pointer-events: none;
        }

        .warning-banner {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
            color: white;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 8px;
            border-left: 4px solid #fbbf24;
            font-size: 14px;
            line-height: 1.5;
        }

        .warning-banner strong {
            color: #fbbf24;
        }

        .info-section {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.2);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            font-size: 13px;
            line-height: 1.4;
        }

        .info-section h4 {
            color: #3b82f6;
            margin-bottom: 10px;
            font-size: 14px;
        }

        .path-list {
            background: rgba(0, 0, 0, 0.3);
            padding: 10px;
            border-radius: 4px;
            margin: 8px 0;
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 11px;
            word-break: break-all;
        }

        .os-section {
            margin-bottom: 12px;
        }

        .os-section strong {
            color: #10b981;
            display: inline-block;
            min-width: 80px;
        }

        .backup-steps {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.2);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            font-size: 13px;
            line-height: 1.4;
        }

        .backup-steps h4 {
            color: #10b981;
            margin-bottom: 10px;
            font-size: 14px;
        }

        .backup-steps ol {
            padding-left: 20px;
        }

        .backup-steps li {
            margin-bottom: 8px;
        }

        .accordion {
            border: 1px solid #3a3a5c;
            border-radius: 8px;
            margin-bottom: 15px;
            overflow: hidden;
        }

        .accordion-header {
            background: #2d3748;
            padding: 12px 15px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 500;
            transition: background 0.2s;
        }

        .accordion-header:hover {
            background: #374151;
        }

        .accordion-content {
            padding: 15px;
            border-top: 1px solid #3a3a5c;
            display: none;
        }

        .accordion.active .accordion-content {
            display: block;
        }

        .accordion-arrow {
            transition: transform 0.2s;
        }

        .accordion.active .accordion-arrow {
            transform: rotate(180deg);
        }

        .status-badge {
            font-size: 11px;
            padding: 2px 8px;
            border-radius: 12px;
            font-weight: 500;
        }

        .status-available {
            background: #10b981;
            color: white;
        }

        .status-unavailable {
            background: #dc2626;
            color: white;
        }

        .status-unknown {
            background: #64748b;
            color: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- ä¾§è¾¹æ  -->
        <div class="sidebar">
            <div class="header">
                <h1>ğŸ•¸ï¸ ä¸ä¹‹æ­Œå­˜æ¡£ç¼–è¾‘å™¨</h1>
                <p style="color: #64748b; font-size: 12px;">ä¸Šä¼ å­˜æ¡£æ–‡ä»¶å¼€å§‹ç¼–è¾‘</p>
            </div>

            <!-- é‡è¦è­¦å‘Š -->
            <div class="warning-banner">
                <strong>âš ï¸ é‡è¦æé†’ï¼š</strong><br>
                åœ¨ä½¿ç”¨æ­¤å·¥å…·å‰ï¼Œè¯·åŠ¡å¿…å¤‡ä»½æ‚¨çš„åŸå§‹å­˜æ¡£æ–‡ä»¶ï¼ä¿®æ”¹å­˜æ¡£æ–‡ä»¶å¯èƒ½å¯¼è‡´æ¸¸æˆæ— æ³•æ­£å¸¸è¿è¡Œæˆ–å­˜æ¡£æŸåã€‚
            </div>

            <!-- æŠ˜å å¼ä¿¡æ¯åŒºåŸŸ -->
            <div class="accordion">
                <div class="accordion-header" onclick="toggleAccordion(this)">
                    <span>ğŸ“ å­˜æ¡£æ–‡ä»¶ä½ç½®</span>
                    <span class="accordion-arrow">â–¼</span>
                </div>
                <div class="accordion-content">
                    <div class="info-section">
                        <h4>ğŸ–¥ï¸ å­˜æ¡£æ–‡ä»¶è·¯å¾„</h4>
                        <div class="os-section">
                            <strong>Windows:</strong>
                            <div class="path-list">%USERPROFILE%\AppData\LocalLow\Team Cherry\Hollow Knight Silksong\</div>
                        </div>
                        <div class="os-section">
                            <strong>macOS:</strong>
                            <div class="path-list">~/Library/Application Support/unity.Team Cherry.Hollow Knight Silksong/</div>
                        </div>
                        <div class="os-section">
                            <strong>Linux:</strong>
                            <div class="path-list">~/.config/unity3d/Team Cherry/Hollow Knight Silksong/</div>
                        </div>
                        <div class="os-section">
                            <strong>Steam Deck:</strong>
                            <div class="path-list">~/.local/share/Steam/steamapps/compatdata/[APPID]/pfx/drive_c/users/steamuser/AppData/LocalLow/Team Cherry/Hollow Knight Silksong/</div>
                        </div>
                        <p style="color: #94a3b8; margin-top: 10px; font-size: 12px;">
                            <strong>æç¤ºï¼š</strong>å­˜æ¡£æ–‡ä»¶é€šå¸¸åä¸º user1.datã€user2.dat ç­‰ã€‚
                        </p>
                    </div>
                </div>
            </div>

            <div class="accordion">
                <div class="accordion-header" onclick="toggleAccordion(this)">
                    <span>ğŸ’¾ å¤‡ä»½æ­¥éª¤</span>
                    <span class="accordion-arrow">â–¼</span>
                </div>
                <div class="accordion-content">
                    <div class="backup-steps">
                        <h4>ğŸ›¡ï¸ å¦‚ä½•å¤‡ä»½å­˜æ¡£</h4>
                        <ol>
                            <li>æ‰¾åˆ°ä¸Šè¿°å¯¹åº”å¹³å°çš„å­˜æ¡£æ–‡ä»¶å¤¹</li>
                            <li>å¤åˆ¶æ•´ä¸ªå­˜æ¡£æ–‡ä»¶å¤¹åˆ°å®‰å…¨ä½ç½®ï¼ˆå¦‚æ¡Œé¢æˆ–æ–‡æ¡£æ–‡ä»¶å¤¹ï¼‰</li>
                            <li>é‡å‘½åå¤‡ä»½æ–‡ä»¶å¤¹ï¼Œæ·»åŠ æ—¥æœŸåç¼€ï¼ˆå¦‚ "å­˜æ¡£å¤‡ä»½_2024-01-01"ï¼‰</li>
                            <li>ç¡®è®¤å¤‡ä»½æ–‡ä»¶å¤¹åŒ…å«æ‰€æœ‰ .dat æ–‡ä»¶</li>
                            <li>ç°åœ¨å¯ä»¥å®‰å…¨åœ°ä½¿ç”¨æ­¤å·¥å…·ç¼–è¾‘å­˜æ¡£</li>
                        </ol>
                        <p style="color: #94a3b8; margin-top: 10px; font-size: 12px;">
                            <strong>æ¢å¤æ–¹æ³•ï¼š</strong>å¦‚æœå‡ºç°é—®é¢˜ï¼Œåˆ é™¤å½“å‰å­˜æ¡£æ–‡ä»¶å¤¹ï¼Œå°†å¤‡ä»½æ–‡ä»¶å¤¹é‡å‘½åå›åŸæ¥çš„åç§°å³å¯ã€‚
                        </p>
                    </div>
                </div>
            </div>

            <div class="accordion">
                <div class="accordion-header" onclick="toggleAccordion(this)">
                    <span>â„¹ï¸ ä½¿ç”¨è¯´æ˜</span>
                    <span class="accordion-arrow">â–¼</span>
                </div>
                <div class="accordion-content">
                    <div class="info-section">
                        <h4>ğŸ® ä½¿ç”¨æ–¹æ³•</h4>
                        <ol style="padding-left: 20px; line-height: 1.6;">
                            <li>å¤‡ä»½åŸå§‹å­˜æ¡£æ–‡ä»¶</li>
                            <li>ä¸Šä¼ å­˜æ¡£æ–‡ä»¶ï¼ˆ.dat æ ¼å¼ï¼‰</li>
                            <li>åœ¨å³ä¾§ç¼–è¾‘å™¨ä¸­ä¿®æ”¹ JSON æ•°æ®</li>
                            <li>æˆ–ä½¿ç”¨å·¦ä¾§å¿«é€Ÿç¼–è¾‘æ§ä»¶</li>
                            <li>ç‚¹å‡»"ä¸‹è½½å­˜æ¡£"è·å–ä¿®æ”¹åçš„æ–‡ä»¶</li>
                            <li>å°†ä¿®æ”¹åçš„æ–‡ä»¶æ›¿æ¢åˆ°æ¸¸æˆå­˜æ¡£æ–‡ä»¶å¤¹</li>
                        </ol>
                        <p style="color: #f59e0b; margin-top: 10px; font-size: 12px;">
                            <strong>æ³¨æ„ï¼š</strong>è¯·ç¡®ä¿ JSON æ ¼å¼æ­£ç¡®ï¼Œå¦åˆ™å¯èƒ½å¯¼è‡´å­˜æ¡£æ— æ³•åŠ è½½ã€‚
                        </p>
                    </div>
                </div>
            </div>

            <!-- ä¸Šä¼ åŒºåŸŸ -->
            <div class="upload-zone" onclick="document.getElementById('fileInput').click()">
                <div class="upload-icon">ğŸ“</div>
                <div>
                    <strong>ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼ å­˜æ¡£æ–‡ä»¶</strong>
                    <br>
                    <small style="color: #64748b;">æ”¯æŒ Silksong å­˜æ¡£æ ¼å¼</small>
                </div>
                <input type="file" id="fileInput" class="file-input" accept=".dat,.save">
            </div>

            <!-- æ§åˆ¶æŒ‰é’® -->
            <div style="display: flex; flex-wrap: wrap; justify-content: center; margin-bottom: 20px;">
                <button class="btn" id="downloadBtn" disabled>ğŸ’¾ ä¸‹è½½å­˜æ¡£</button>
                <button class="btn btn-secondary" id="resetBtn" disabled>ğŸ”„ é‡ç½®ä¿®æ”¹</button>
                <button class="btn btn-danger" id="clearBtn" disabled>ğŸ—‘ï¸ æ¸…é™¤æ•°æ®</button>
            </div>

            <!-- å¿«é€Ÿç¼–è¾‘æ§ä»¶ -->
            <div id="quickControls" class="hidden">
                <div class="control-group">
                    <h3>ğŸ’° å¿«æ·æ“ä½œ</h3>
                    
                    <!-- å¿µç æ•°é‡ -->
                    <div class="input-group">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                            <label>å¿µç æ•°é‡</label>
                            <span id="geoStatus" class="status-badge">â€”</span>
                        </div>
                        <input type="number" id="geoInput" min="0" max="999999" placeholder="è¾“å…¥æ•°é‡">
                        <p style="color: #94a3b8; font-size: 11px; margin-top: 5px;">
                            å½“å‰å¿µç æ•°é‡ (playerData.geo)
                        </p>
                    </div>

                    <!-- ç”Ÿå‘½å€¼ -->
                    <div class="input-group">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                            <label>ç”Ÿå‘½å€¼</label>
                            <span id="healthStatus" class="status-badge">â€”</span>
                        </div>
                        <input type="number" id="healthInput" min="1" max="50" placeholder="è¾“å…¥ç”Ÿå‘½å€¼">
                        <p style="color: #94a3b8; font-size: 11px; margin-top: 5px;">
                            æœ€å¤§ç”Ÿå‘½å€¼ (maxHealth & maxHealthBase)
                        </p>
                    </div>

                    <!-- éª¨é’‰å‡çº§æ¬¡æ•° -->
                    <div class="input-group">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                            <label>éª¨é’‰å‡çº§æ¬¡æ•°</label>
                            <span id="nailStatus" class="status-badge">â€”</span>
                        </div>
                        <input type="number" id="nailInput" min="0" max="1000" placeholder="è¾“å…¥å‡çº§æ¬¡æ•°">
                        <p style="color: #94a3b8; font-size: 11px; margin-top: 5px;">
                            éª¨é’‰å‡çº§æ¬¡æ•° (playerData.nailUpgrades)
                        </p>
                    </div>

                    <!-- ç”²å£³ç¢ç‰‡ -->
                    <div class="input-group">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                            <label>ç”²å£³ç¢ç‰‡</label>
                            <span id="shellStatus" class="status-badge">â€”</span>
                        </div>
                        <input type="number" id="shellInput" min="0" max="999" placeholder="è¾“å…¥æ•°é‡">
                        <p style="color: #94a3b8; font-size: 11px; margin-top: 5px;">
                            ç”²å£³ç¢ç‰‡æ•°é‡ (playerData.ShellShards)
                        </p>
                    </div>

                    <!-- çµä¸è‡ªåŠ¨å›å¤é€Ÿåº¦ -->
                    <div class="input-group">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                            <label>çµä¸è‡ªåŠ¨å›å¤é€Ÿåº¦</label>
                            <span id="silkStatus" class="status-badge">â€”</span>
                        </div>
                        <input type="number" id="silkInput" min="0" max="100" placeholder="è¾“å…¥é€Ÿåº¦">
                        <p style="color: #94a3b8; font-size: 11px; margin-top: 5px;">
                            çµä¸è‡ªåŠ¨å›å¤é€Ÿåº¦ (playerData.silkRegenMax)
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- ä¸»å†…å®¹åŒº -->
        <div class="main-content">
            <div class="editor-container" id="editorContainer">
                <div class="upload-placeholder" id="uploadPlaceholder">
                    <div class="upload-placeholder-icon">ğŸ•¸ï¸</div>
                    <h2>ç©ºæ´éª‘å£«ï¼šä¸ä¹‹æ­Œå­˜æ¡£ç¼–è¾‘å™¨</h2>
                    <p>è¯·åœ¨å·¦ä¾§ä¸Šä¼ å­˜æ¡£æ–‡ä»¶å¼€å§‹ç¼–è¾‘</p>
                </div>
                <div id="monacoEditor" style="height: 100%; display: none;"></div>
            </div>
            
            <!-- çŠ¶æ€æ  -->
            <div class="status-bar">
                <div class="status-indicator">
                    <div class="status-dot status-info" id="statusDot"></div>
                    <span id="statusText">å°±ç»ª</span>
                </div>
                <div id="statusInfo">
                    <span>JSON æ ¼å¼æ­£ç¡®</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast é€šçŸ¥ -->
    <div id="toast" class="toast"></div>

    <script>
        // å…¨å±€å˜é‡
        let editor = null;
        let saveData = null;
        let originalJsonContent = '';
        let isValidJson = true;

        // AES å¯†é’¥å’Œå¤´éƒ¨ä¿¡æ¯
        const AES_KEY = 'UKu52ePUBwetZ9wNX88o54dnfKRu0T1l';
        const CSHARP_HEADER = new Uint8Array([0, 1, 0, 0, 0, 255, 255, 255, 255, 1, 0, 0, 0, 0, 0, 0, 0, 6, 1, 0, 0, 0]);

        // åˆå§‹åŒ– Monaco ç¼–è¾‘å™¨
        function initMonacoEditor() {
            require.config({ paths: { vs: 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.34.1/min/vs' }});
            require(['vs/editor/editor.main'], function () {
                editor = monaco.editor.create(document.getElementById('monacoEditor'), {
                    value: '',
                    language: 'json',
                    theme: 'vs-dark',
                    automaticLayout: true,
                    formatOnPaste: true,
                    formatOnType: true,
                    scrollBeyondLastLine: false,
                    minimap: { enabled: false },
                    fontSize: 14,
                    lineNumbers: 'on',
                    folding: true,
                    wordWrap: 'on'
                });

                // ç›‘å¬å†…å®¹å˜åŒ–
                editor.onDidChangeModelContent(() => {
                    const content = editor.getValue();
                    validateJson(content);
                    updateQuickControls();
                });
            });
        }

        // æ˜¾ç¤ºé€šçŸ¥
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type} show`;
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // æ›´æ–°çŠ¶æ€
        function updateStatus(message, type = 'info') {
            const statusDot = document.getElementById('statusDot');
            const statusText = document.getElementById('statusText');
            
            statusDot.className = `status-dot status-${type}`;
            statusText.textContent = message;
        }

        // ç§»é™¤æ–‡ä»¶å¤´éƒ¨
        function removeHeader(data) {
            let offset = 22; // C# å¤´éƒ¨é•¿åº¦
            
            // è§£æé•¿åº¦å‰ç¼€å­—ç¬¦ä¸²å¤´éƒ¨ (LEB128 ç¼–ç )
            let length = 0;
            let shift = 0;
            let lengthBytes = 0;
            
            for (let i = 0; i < 5 && offset + i < data.length; i++) {
                const byte = data[offset + i];
                length |= (byte & 0x7F) << shift;
                lengthBytes++;
                if ((byte & 0x80) === 0) {
                    break;
                }
                shift += 7;
            }
            
            offset += lengthBytes;
            
            // ç§»é™¤å°¾éƒ¨å­—èŠ‚ (11) - è¿”å›æ—¶ä¸åŒ…å«æœ€åä¸€ä¸ªå­—èŠ‚
            return data.slice(offset, -1);
        }

        // æ·»åŠ æ–‡ä»¶å¤´éƒ¨
        function addHeader(base64Data) {
            const dataLength = base64Data.length;
            
            // ç”Ÿæˆé•¿åº¦å¤´éƒ¨ (LEB128)
            const lengthHeader = [];
            let length = dataLength;
            
            while (length >= 0x80) {
                lengthHeader.push((length & 0x7F) | 0x80);
                length >>>= 7;
            }
            lengthHeader.push(length & 0x7F);
            
            // åˆå¹¶æ‰€æœ‰éƒ¨åˆ†
            const result = new Uint8Array(CSHARP_HEADER.length + lengthHeader.length + base64Data.length + 1);
            let offset = 0;
            
            // C# å¤´éƒ¨
            result.set(CSHARP_HEADER, offset);
            offset += CSHARP_HEADER.length;
            
            // é•¿åº¦å¤´éƒ¨
            result.set(lengthHeader, offset);
            offset += lengthHeader.length;
            
            // Base64 æ•°æ®
            result.set(base64Data, offset);
            offset += base64Data.length;
            
            // å°¾éƒ¨å­—èŠ‚
            result[offset] = 11;
            
            return result;
        }

        // è§£ç å­˜æ¡£æ–‡ä»¶
        function decodeSilksongSave(fileData) {
            try {
                const data = new Uint8Array(fileData);
                
                // 1. ç§»é™¤å¤´éƒ¨
                const dataNoHeader = removeHeader(data);
                
                // 2. Base64 è§£ç 
                const base64String = new TextDecoder().decode(dataNoHeader)
                    .replace(/\n/g, '')
                    .replace(/\r/g, '')
                    .trim();
                
                const encryptedData = CryptoJS.enc.Base64.parse(base64String);
                
                // 3. AES è§£å¯†
                const decrypted = CryptoJS.AES.decrypt(
                    { ciphertext: encryptedData },
                    CryptoJS.enc.Utf8.parse(AES_KEY),
                    {
                        mode: CryptoJS.mode.ECB,
                        padding: CryptoJS.pad.Pkcs7
                    }
                );
                
                // 4. è§£æ JSON
                const jsonString = decrypted.toString(CryptoJS.enc.Utf8);
                return JSON.parse(jsonString);
                
            } catch (error) {
                console.error('è§£ç å­˜æ¡£æ–‡ä»¶é”™è¯¯:', error);
                throw new Error('è§£ç å­˜æ¡£æ–‡ä»¶å¤±è´¥ã€‚è¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼ã€‚');
            }
        }

        // ç¼–ç å­˜æ¡£æ–‡ä»¶
        function encodeSilksongSave(saveData) {
            try {
                // 1. è½¬æ¢ä¸º JSON å­—ç¬¦ä¸²
                const jsonString = JSON.stringify(saveData, null, 0);
                
                // 2. AES åŠ å¯†
                const encrypted = CryptoJS.AES.encrypt(
                    jsonString,
                    CryptoJS.enc.Utf8.parse(AES_KEY),
                    {
                        mode: CryptoJS.mode.ECB,
                        padding: CryptoJS.pad.Pkcs7
                    }
                );
                
                // 3. Base64 ç¼–ç 
                const base64String = encrypted.toString();
                const base64Data = new TextEncoder().encode(base64String);
                
                // 4. æ·»åŠ å¤´éƒ¨
                return addHeader(base64Data);
                
            } catch (error) {
                console.error('ç¼–ç å­˜æ¡£æ–‡ä»¶é”™è¯¯:', error);
                throw new Error('ç¼–ç å­˜æ¡£æ–‡ä»¶å¤±è´¥ã€‚è¯·æ£€æŸ¥æ‚¨çš„ä¿®æ”¹ã€‚');
            }
        }

        // éªŒè¯ JSON
        function validateJson(jsonString) {
            try {
                JSON.parse(jsonString);
                isValidJson = true;
                document.getElementById('statusInfo').textContent = 'JSON æ ¼å¼æ­£ç¡®';
                return true;
            } catch (error) {
                isValidJson = false;
                document.getElementById('statusInfo').textContent = 'JSON æ ¼å¼é”™è¯¯: ' + error.message;
                return false;
            }
        }

        // æ›´æ–°å¿«é€Ÿæ§ä»¶
        function updateQuickControls() {
            if (!editor || !isValidJson) return;
            
            try {
                const content = editor.getValue();
                const data = JSON.parse(content);
                
                // æ›´æ–°å¿µç å­—æ®µ
                updateFieldControl(data, 'geo', 'geoInput', 'geoStatus', 
                    ['playerData.geo'], 'number');
                
                // æ›´æ–°ç”Ÿå‘½å€¼å­—æ®µ (åŒæ—¶å¤„ç†maxHealthå’ŒmaxHealthBase)
                updateHealthFields(data);
                
                // æ›´æ–°éª¨é’‰å‡çº§æ¬¡æ•°å­—æ®µ
                updateFieldControl(data, 'nail', 'nailInput', 'nailStatus', 
                    ['playerData.nailUpgrades'], 'number');
                
                // æ›´æ–°ç”²å£³ç¢ç‰‡å­—æ®µ
                updateFieldControl(data, 'shell', 'shellInput', 'shellStatus', 
                    ['playerData.ShellShards'], 'number');
                
                // æ›´æ–°çµä¸è‡ªåŠ¨å›å¤é€Ÿåº¦å­—æ®µ
                updateFieldControl(data, 'silk', 'silkInput', 'silkStatus', 
                    ['playerData.silkRegenMax'], 'number');
                
            } catch (error) {
                console.error('æ›´æ–°å¿«é€Ÿæ§ä»¶é”™è¯¯:', error);
                // é‡ç½®æ‰€æœ‰çŠ¶æ€ä¸ºæœªçŸ¥
                ['geoStatus', 'healthStatus', 'nailStatus', 'shellStatus', 'silkStatus'].forEach(statusId => {
                    const status = document.getElementById(statusId);
                    status.textContent = 'â€”';
                    status.className = 'status-badge status-unknown';
                });
            }
        }

        // é€šç”¨å­—æ®µæ§ä»¶æ›´æ–°å‡½æ•°
        function updateFieldControl(data, fieldType, inputId, statusId, fieldPaths, valueType) {
            const input = document.getElementById(inputId);
            const status = document.getElementById(statusId);
            
            let foundField = false;
            let fieldValue = null;
            let actualFieldPath = '';
            
            // å°è¯•æ‰€æœ‰å¯èƒ½çš„å­—æ®µè·¯å¾„
            for (const path of fieldPaths) {
                const value = getNestedValue(data, path);
                if (value !== undefined) {
                    foundField = true;
                    fieldValue = value;
                    actualFieldPath = path;
                    break;
                }
            }
            
            if (foundField) {
                input.value = fieldValue.toString();
                input.disabled = false;
                status.textContent = 'âœ“';
                status.className = 'status-badge status-available';
                status.title = `å­—æ®µè·¯å¾„: ${actualFieldPath}`;
                
                // æ ¹æ®å­—æ®µç±»å‹è®¾ç½®å ä½ç¬¦
                if (fieldType === 'nail') {
                    input.placeholder = 'è¾“å…¥å‡çº§æ¬¡æ•° (0-1000)';
                } else {
                    input.placeholder = 'è¾“å…¥æ•°é‡';
                }
            } else {
                input.value = '';
                input.disabled = true;
                status.textContent = 'âœ—';
                status.className = 'status-badge status-unavailable';
                status.title = 'å­—æ®µä¸å¯ç”¨';
                input.placeholder = 'å­—æ®µä¸å¯ç”¨';
            }
            
            // å­˜å‚¨å­—æ®µè·¯å¾„åˆ°inputå…ƒç´ ï¼Œç”¨äºæ›´æ–°æ—¶ä½¿ç”¨
            input.dataset.fieldPath = actualFieldPath;
            input.dataset.valueType = valueType;
        }

        // è·å–åµŒå¥—å¯¹è±¡çš„å€¼
        function getNestedValue(obj, path) {
            return path.split('.').reduce((current, key) => {
                return current && current[key] !== undefined ? current[key] : undefined;
            }, obj);
        }

        // ä¸“é—¨å¤„ç†ç”Ÿå‘½å€¼å­—æ®µçš„å‡½æ•°
        function updateHealthFields(data) {
            const healthInput = document.getElementById('healthInput');
            const healthStatus = document.getElementById('healthStatus');
            
            const maxHealth = getNestedValue(data, 'playerData.maxHealth');
            const maxHealthBase = getNestedValue(data, 'playerData.maxHealthBase');
            
            const hasMaxHealth = maxHealth !== undefined;
            const hasMaxHealthBase = maxHealthBase !== undefined;
            
            if (hasMaxHealth || hasMaxHealthBase) {
                // ä¼˜å…ˆæ˜¾ç¤ºmaxHealthï¼Œå¦‚æœæ²¡æœ‰åˆ™æ˜¾ç¤ºmaxHealthBase
                const displayValue = hasMaxHealth ? maxHealth : maxHealthBase;
                healthInput.value = displayValue.toString();
                healthInput.disabled = false;
                healthStatus.textContent = 'âœ“';
                healthStatus.className = 'status-badge status-available';
                
                // è®¾ç½®å·¥å…·æç¤ºï¼Œæ˜¾ç¤ºæ‰¾åˆ°äº†å“ªäº›å­—æ®µ
                let tooltip = 'æ‰¾åˆ°å­—æ®µ: ';
                if (hasMaxHealth && hasMaxHealthBase) {
                    tooltip += 'maxHealth & maxHealthBase';
                } else if (hasMaxHealth) {
                    tooltip += 'maxHealth';
                } else {
                    tooltip += 'maxHealthBase';
                }
                healthStatus.title = tooltip;
                healthInput.placeholder = 'è¾“å…¥ç”Ÿå‘½å€¼';
                
                // å­˜å‚¨å­—æ®µä¿¡æ¯åˆ°inputå…ƒç´ 
                healthInput.dataset.hasMaxHealth = hasMaxHealth;
                healthInput.dataset.hasMaxHealthBase = hasMaxHealthBase;
                healthInput.dataset.valueType = 'number';
            } else {
                healthInput.value = '';
                healthInput.disabled = true;
                healthStatus.textContent = 'âœ—';
                healthStatus.className = 'status-badge status-unavailable';
                healthStatus.title = 'å­—æ®µä¸å¯ç”¨';
                healthInput.placeholder = 'å­—æ®µä¸å¯ç”¨';
            }
        }

        // å¤„ç†æ–‡ä»¶ä¸Šä¼ 
        function handleFileUpload(file) {
            updateStatus('æ­£åœ¨åŠ è½½...', 'info');
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const decoded = decodeSilksongSave(e.target.result);
                    const jsonString = JSON.stringify(decoded, null, 2);
                    
                    saveData = decoded;
                    originalJsonContent = jsonString;
                    
                    // æ˜¾ç¤ºç¼–è¾‘å™¨å¹¶éšè—ä¸Šä¼ æç¤º
                    document.getElementById('uploadPlaceholder').style.display = 'none';
                    document.getElementById('monacoEditor').style.display = 'block';
                    document.getElementById('quickControls').classList.remove('hidden');
                    
                    // è®¾ç½®ç¼–è¾‘å™¨å†…å®¹
                    if (editor) {
                        editor.setValue(jsonString);
                    }
                    
                    // å¯ç”¨æŒ‰é’®
                    document.getElementById('downloadBtn').disabled = false;
                    document.getElementById('resetBtn').disabled = false;
                    document.getElementById('clearBtn').disabled = false;
                    
                    updateStatus('æ–‡ä»¶åŠ è½½æˆåŠŸ', 'success');
                    showToast('å­˜æ¡£æ–‡ä»¶ä¸Šä¼ æˆåŠŸï¼', 'success');
                    
                } catch (error) {
                    console.error('ä¸Šä¼ é”™è¯¯:', error);
                    updateStatus('æ–‡ä»¶åŠ è½½å¤±è´¥', 'error');
                    showToast('ä¸Šä¼ å¤±è´¥: ' + error.message, 'error');
                }
            };
            
            reader.readAsArrayBuffer(file);
        }

        // ä¸‹è½½æ–‡ä»¶
        function downloadFile() {
            if (!editor || !isValidJson) {
                showToast('è¯·ç¡®ä¿ JSON æ ¼å¼æ­£ç¡®', 'error');
                return;
            }

            try {
                const jsonContent = editor.getValue();
                const parsedData = JSON.parse(jsonContent);
                const encodedData = encodeSilksongSave(parsedData);
                
                const blob = new Blob([encodedData], { type: 'application/octet-stream' });
                const url = URL.createObjectURL(blob);
                
                const link = document.createElement('a');
                link.href = url;
                link.download = 'silksong_save_modified.dat';
                document.body.appendChild(link);
                link.click();
                
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                showToast('å­˜æ¡£æ–‡ä»¶ä¸‹è½½æˆåŠŸï¼', 'success');
                
            } catch (error) {
                console.error('ä¸‹è½½é”™è¯¯:', error);
                showToast('ä¸‹è½½å¤±è´¥: ' + error.message, 'error');
            }
        }

        // é‡ç½®ä¿®æ”¹
        function resetChanges() {
            if (originalJsonContent && editor) {
                editor.setValue(originalJsonContent);
                showToast('å·²é‡ç½®ä¸ºåŸå§‹å†…å®¹', 'success');
            }
        }

        // æ¸…é™¤æ‰€æœ‰æ•°æ®
        function clearAll() {
            if (confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) {
                saveData = null;
                originalJsonContent = '';
                
                if (editor) {
                    editor.setValue('');
                }
                
                document.getElementById('uploadPlaceholder').style.display = 'flex';
                document.getElementById('monacoEditor').style.display = 'none';
                document.getElementById('quickControls').classList.add('hidden');
                
                // ç¦ç”¨æŒ‰é’®
                document.getElementById('downloadBtn').disabled = true;
                document.getElementById('resetBtn').disabled = true;
                document.getElementById('clearBtn').disabled = true;
                
                updateStatus('å°±ç»ª', 'info');
                showToast('æ•°æ®å·²æ¸…é™¤', 'success');
            }
        }

        // å¿«é€Ÿç¼–è¾‘åŠŸèƒ½
        function updateField(path, value) {
            if (!editor || !isValidJson) return;
            
            try {
                const jsonContent = editor.getValue();
                const data = JSON.parse(jsonContent);
                
                // æ ¹æ®è·¯å¾„æ›´æ–°å€¼
                const pathParts = path.split('.');
                let target = data;
                
                for (let i = 0; i < pathParts.length - 1; i++) {
                    if (target[pathParts[i]] === undefined) {
                        target[pathParts[i]] = {};
                    }
                    target = target[pathParts[i]];
                }
                
                target[pathParts[pathParts.length - 1]] = value;
                
                const updatedJson = JSON.stringify(data, null, 2);
                editor.setValue(updatedJson);
                
            } catch (error) {
                console.error('æ›´æ–°å­—æ®µé”™è¯¯:', error);
            }
        }

        // æŠ˜å èœå•åŠŸèƒ½
        function toggleAccordion(header) {
            const accordion = header.parentElement;
            const isActive = accordion.classList.contains('active');
            
            // å…³é—­æ‰€æœ‰å…¶ä»–æŠ˜å èœå•
            document.querySelectorAll('.accordion.active').forEach(acc => {
                if (acc !== accordion) {
                    acc.classList.remove('active');
                }
            });
            
            // åˆ‡æ¢å½“å‰èœå•çŠ¶æ€
            if (isActive) {
                accordion.classList.remove('active');
            } else {
                accordion.classList.add('active');
            }
        }

        // äº‹ä»¶ç›‘å¬å™¨
        document.addEventListener('DOMContentLoaded', function() {
            // åˆå§‹åŒ–ç¼–è¾‘å™¨
            initMonacoEditor();
            
            // æ–‡ä»¶è¾“å…¥
            const fileInput = document.getElementById('fileInput');
            fileInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    handleFileUpload(file);
                }
            });
            
            // æ‹–æ”¾å¤„ç†
            const uploadZone = document.querySelector('.upload-zone');
            uploadZone.addEventListener('dragover', function(e) {
                e.preventDefault();
                uploadZone.classList.add('dragover');
            });
            
            uploadZone.addEventListener('dragleave', function(e) {
                e.preventDefault();
                uploadZone.classList.remove('dragover');
            });
            
            uploadZone.addEventListener('drop', function(e) {
                e.preventDefault();
                uploadZone.classList.remove('dragover');
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleFileUpload(files[0]);
                }
            });
            
            // æŒ‰é’®äº‹ä»¶
            document.getElementById('downloadBtn').addEventListener('click', downloadFile);
            document.getElementById('resetBtn').addEventListener('click', resetChanges);
            document.getElementById('clearBtn').addEventListener('click', clearAll);
            
            // é€šç”¨è¾“å…¥æ¡†äº‹ä»¶å¤„ç†å‡½æ•°
            function setupFieldEventListener(inputId) {
                document.getElementById(inputId).addEventListener('input', function(e) {
                    const value = e.target.value;
                    
                    // å¦‚æœå­—æ®µä¸å¯ç”¨ï¼Œä¸å¤„ç†è¾“å…¥
                    if (e.target.disabled) return;
                    
                    // éªŒè¯è¾“å…¥æ ¼å¼
                    let isValidInput = false;
                    let processedValue = null;
                    
                    if (value === '') {
                        isValidInput = true;
                    } else {
                        // æ‰€æœ‰å­—æ®µéƒ½åªå…è®¸éè´Ÿæ•´æ•°
                        if (/^\d+$/.test(value)) {
                            const numValue = parseInt(value, 10);
                            
                            // æ ¹æ®å­—æ®µç±»å‹è®¾ç½®èŒƒå›´é™åˆ¶
                            if (inputId === 'nailInput' && numValue <= 1000) {
                                isValidInput = true;
                                processedValue = numValue;
                            } else if (inputId !== 'nailInput' && numValue >= 0) {
                                isValidInput = true;
                                processedValue = numValue;
                            }
                        }
                    }
                    
                    if (isValidInput && value !== '') {
                        // ç‰¹æ®Šå¤„ç†ç”Ÿå‘½å€¼å­—æ®µ
                        if (inputId === 'healthInput') {
                            updateHealthValues(processedValue);
                        } else {
                            // å…¶ä»–å­—æ®µä½¿ç”¨åŸæœ‰é€»è¾‘
                            const fieldPath = e.target.dataset.fieldPath;
                            if (fieldPath) {
                                updateField(fieldPath, processedValue);
                            }
                        }
                    } else if (!isValidInput) {
                        // å¦‚æœè¾“å…¥æ— æ•ˆï¼Œæ¢å¤åˆ°ä¹‹å‰çš„å€¼
                        e.target.value = e.target.value.slice(0, -1);
                    }
                });
            }
            
            // ä¸“é—¨æ›´æ–°ç”Ÿå‘½å€¼çš„å‡½æ•°
            function updateHealthValues(value) {
                const healthInput = document.getElementById('healthInput');
                const hasMaxHealth = healthInput.dataset.hasMaxHealth === 'true';
                const hasMaxHealthBase = healthInput.dataset.hasMaxHealthBase === 'true';
                
                // åŒæ—¶æ›´æ–°ä¸¤ä¸ªå­—æ®µ
                if (hasMaxHealth) {
                    updateField('playerData.maxHealth', value);
                }
                if (hasMaxHealthBase) {
                    updateField('playerData.maxHealthBase', value);
                }
            }
            
            // ä¸ºæ‰€æœ‰è¾“å…¥æ¡†è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
            ['geoInput', 'healthInput', 'nailInput', 'shellInput', 'silkInput'].forEach(setupFieldEventListener);
        });
    </script>
</body>
</html>